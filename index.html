<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="pouchdb.js"></script>
    <script src="pouchdb.indexeddb.js"></script>
    <title>PouchDB purge feature demo</title>
  </head>
  <body>
    <h1>Hi</h1>

    <ul id="docs">
      <li>No docs</li>
    </ul>
    <br /><br />
    <button onClick="handleCreate()">Create document</button><br /><br />
    <button onClick="handleUpdate()">Update document</button>
    <button onClick="handleDelete()">Delete document</button>
    <input
      type="text"
      id="update-doc-id"
      placeholder="Document ID"
    /><br /><br />
    <button onClick="handleView()">Create view</button>
    <button onClick="handleQueryView()">Query view</button>
    <input type="text" id="query-view-id" placeholder="View ID" /><br /><br />

    <button onClick="handleEmpty()">Empty database</button>

    <script>
      let db,
        db1,
        db2,
        i = 0;
      const DB_NAME = "purge-demo";
      const adapter = "indexeddb";

      async function clearDatabase(name) {
        try {
          const _db = new PouchDB(name, { adapter });
          await _db.destroy();
        } catch {}
      }

      function findPathToLeaf(revs, targetRev) {
        var path = [];
        var toVisit = revs.slice();

        var node;
        while ((node = toVisit.pop())) {
          var pos = node.pos;
          var tree = node.ids;
          var rev = `${pos}-${tree[0]}`;
          path.push(rev);
          var branches = tree[2];
          if (rev === targetRev) return path;
          if (branches.length === 0) {
            path = [];
          }
          for (var i = 0, len = branches.length; i < len; i++) {
            toVisit.push({ pos: pos + 1, ids: branches[i] });
          }
        }
        return path;
      }

      function attemptPurge() {
        db1._getRevisionTree("something", (whatever, revs) => {
          const path = findPathToLeaf(
            revs,
            "6-2d0ab4f4089a57c95d52bfd2d66b823d"
          );
          console.log("path", path);
        });
      }

      /*
       * 1-a - 2-a -- 3-a - 4-a - 5-a - 6-a
       *           \           \
       *            \            5-c - 6-c
       *              3-b - 4-b
       *
       * three leaves: 6-a, 6-c, and 4-b.
       * 6-a is the winning leaf.
       *
       * for a purge, we want to retrieve all *unique* revs from the given leaf until
       * we find a branching (i.e., revs aren't unique anymore). with
       * ```
       *   db.get(docId, { open_revs: 'all' })
       * ```
       * we can at least check whether the given rev is a leaf or not.
       *
       * ~ ~ ~
       *
       * rev hashes:
       * 1-a 1-9692d401ed2d3434827608278bdc36e3
       * 2-a 2-37aa033df08c21b4f56f1da2081e9e00
       * 3-a 3-df226cb9a2e5bdd3e6be009fd51f47c1
       * 4-a 4-6e94d345514a08620c3176eea080d3ec
       * 5-a 5-df4a81cd21c75c71974d96e88a68fc2f
       * 6-a 6-3f7f6c55c27bf54c009b661607a9fe05 leaf
       * 5-c 5-0b84bfea5508e2020feb07384714a987
       * 6-c 6-2d0ab4f4089a57c95d52bfd2d66b823d leaf
       * 3-b 3-43f6d5557d6de39488c64bb2c684ae7c
       * 4-b 4-a3b44168027079c2692a7d8eb35e9643 leaf
       */
      async function createTree() {
        try {
          await clearDatabase("db1");
          await clearDatabase("db2");

          db1 = new PouchDB("db1", { adapter });
          db2 = new PouchDB("db2", { adapter });
          const docId = "something";

          console.log(`Building the following rev tree for doc \`${docId}\`:
1-a - 2-a -- 3-a - 4-a - 5-a - 6-a
          \\            \\
           \\             5-c - 6-c
             3-b - 4-b

Individual rev hashes:
1-a 1-9692d401ed2d3434827608278bdc36e3
2-a 2-37aa033df08c21b4f56f1da2081e9e00
3-a 3-df226cb9a2e5bdd3e6be009fd51f47c1
4-a 4-6e94d345514a08620c3176eea080d3ec
5-a 5-df4a81cd21c75c71974d96e88a68fc2f
6-a 6-3f7f6c55c27bf54c009b661607a9fe05 leaf
5-c 5-0b84bfea5508e2020feb07384714a987
6-c 6-2d0ab4f4089a57c95d52bfd2d66b823d leaf
3-b 3-43f6d5557d6de39488c64bb2c684ae7c
4-b 4-a3b44168027079c2692a7d8eb35e9643 leaf`);

          const doc_1a = await db1.put({ _id: docId, key: "1-a" });
          const doc_2a = await db1.put({
            _id: docId,
            _rev: doc_1a.rev,
            key: "2-a",
          });

          await PouchDB.sync(db1, db2);

          const doc_3a = await db1.put({
            _id: docId,
            _rev: doc_2a.rev,
            key: "3-a",
          });
          const doc_3b = await db2.put({
            _id: docId,
            _rev: doc_2a.rev,
            key: "3-b",
          });

          const doc_4a = await db1.put({
            _id: docId,
            _rev: doc_3a.rev,
            key: "4-a",
          });
          const doc_4b = await db2.put({
            _id: docId,
            _rev: doc_3b.rev,
            key: "4-b",
          });

          await PouchDB.sync(db2, db1);

          const doc_5a = await db1.put({
            _id: docId,
            _rev: doc_4a.rev,
            key: "5-a",
          });
          const doc_6a = await db1.put({
            _id: docId,
            _rev: doc_5a.rev,
            key: "6-a",
          });

          const doc_5b = await db2.put({
            _id: docId,
            _rev: doc_4a.rev,
            key: "5-b",
          });
          const doc_6b = await db2.put({
            _id: docId,
            _rev: doc_5b.rev,
            key: "6-b",
          });

          await PouchDB.sync(db2, db1);
        } catch (err) {
          console.error(err);
        }
      }

      async function handleCreate() {
        await db.put({
          _id: `dummy-${++i}`,
          index: i,
          title: `Dummy item ${i}`,
        });

        await updateDocsList();
      }

      async function handleUpdate() {
        const id = document.getElementById("update-doc-id").value;
        if (!id) {
          alert("Please enter a document ID.");
          return;
        }

        const doc = await db.get(id);
        if (!doc) {
          alert(`Can\'t find doc ${doc}`);
          return;
        }
        const newIndex = doc.index + 1000;
        doc.index = newIndex;
        doc.title = `Dummy item ${newIndex}`;
        await db.put(doc);
        await updateDocsList();
      }

      async function handleView() {
        const ddoc = {
          _id: `_design/my_index_${++i}`,
          views: {
            by_index: {
              map: function (doc) {
                emit(doc.index);
              }.toString(),
            },
          },
        };

        await db.put(ddoc);
        console.log(`Created view ${ddoc._id}`);
      }

      async function handleDelete() {
        const id = document.getElementById("update-doc-id").value;
        if (!id) {
          alert("Please enter a document ID.");
          return;
        }

        const doc = await db.get(id);
        if (!doc) {
          alert(`Can\'t find doc ${doc}`);
          return;
        }

        await db.remove(doc);
        await updateDocsList();
      }

      async function handleQueryView() {
        const id = document.getElementById("query-view-id").value;
        if (!id) {
          alert("Please enter a view ID.");
          return;
        }

        const results = await db.query(`${id}/by_index`, {
          limit: 0, // don't return any results
        });
        console.log(results);
      }

      async function purge(docId, rev) {}

      async function createAndPurge(opts = {}) {
        const destroy =
          typeof opts.destroy === "undefined" ? true : !!opts.destroy;

        // create db
        const name = `${DB_NAME}_${++i}`;
        const db = new PouchDB(name, {
          adapter: "indexeddb",
        });
        console.log(`~ ~ ~ created db: ${name}`);

        // create doc
        const docId = `dummy-${++i}`;
        await db.put({
          _id: docId,
          index: i,
          title: `Dummy item ${i}`,
        });
        const doc = await db.get(docId);
        console.log("created doc id", doc._id, "rev", doc._rev);

        // list all
        console.log("~ ~ ~ all docs ~ ~ ~");
        console.log(
          await db.allDocs({
            include_docs: true,
          })
        );

        // create index & query for view update
        const indexId = `my_index_${++i}`;
        const ddoc = {
          _id: `_design/${indexId}`,
          views: {
            by_index: {
              map: function (doc) {
                emit(doc.index);
              }.toString(),
            },
          },
        };
        await db.put(ddoc);
        console.log(`~ ~ ~ created view: ${indexId}`);

        // update view
        console.log("~ ~ ~ view query result:");
        console.log(
          await db.query(`${indexId}/by_index`, {
            limit: 0, // don't return any results
          })
        );

        // do the purge
        console.log(await db._purge(doc._id, doc._rev));

        // update view
        console.log("~ ~ ~ view query result:");
        console.log(
          await db.query(`${indexId}/by_index`, {
            limit: 0, // don't return any results
          })
        );

        // list all
        console.log("~ ~ ~ all docs ~ ~ ~");
        console.log(
          await db.allDocs({
            include_docs: true,
          })
        );

        if (destroy) {
          console.log("~ ~ ~  cleaning up");
          db.destroy();
        }

        return db;
      }

      async function handleEmpty() {
        await db.destroy();
        db = new PouchDB(DB_NAME, { adapter: "indexeddb" });
        console.log("Created new db with adapter", db.adapter);
        await updateDocsList();
      }

      async function updateDocsList() {
        const container = document.getElementById("docs");
        const docs = (
          await db.allDocs({
            include_docs: true,
          })
        ).rows;

        container.innerHTML = docs
          .map(
            (result) => `<li><pre>${JSON.stringify(result, null, 2)}</pre></li>`
          )
          .join("");
      }

      async function main() {
        db = new PouchDB(DB_NAME, { adapter: "indexeddb" });

        await handleEmpty();
        await updateDocsList();
      }

      // main();
    </script>
  </body>
</html>
